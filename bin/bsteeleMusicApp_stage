#!/bin/tcsh
set debug=0
set isBeta=1
set app=bsteeleMusicApp
set flavor=beta

while ( $#argv > 0 )
	switch ( $1 )
	case '-a':
	case '-alpha':
		set isBeta=1
		set flavor=alpha
		shift
		continue;
#	case '-beta':
#		set isBeta=1
#		shift
#		continue;
	case '-d':		#	debug
	case '-debug':
		set debug=1
		shift
		continue;
	default:
		echo unknown argument: $1
		exit -1;
		breaksw;
	endsw

	break;
end


if ( $debug != 0 ) then
	set echo; set verbose
endif

set dst=/var/www/html/public_html
if ( $isBeta != 0 ) then
	set dst=$dst/$flavor
endif
set git=~/github/bsteeleMusicFlutter
set target=$git/build/web
cd $git

#	build the release version
flutter clean
utcDate > lib/assets/utcDate.txt
#flutter config --enable-web
flutter build web

#flutter build appbundle
#   aap: build/app/outputs/bundle/release/app-release.aab

#	clear the last one
mkdir -p $dst
rm  -rf $dst/$app

#	copy to localhost website
cp -r build/web $dst/$app
#	clean up for public distribution:
rm $dst/$app/main.dart.js.map

#	send to flavor's web location
set gs=gs://www.bsteele.com/$flavor/$app
gsutil -m -q rsync -d -R -x 'allSongs\.songlyrics$' $dst/$app/ $gs 	#	source needs the /
gsutil -m -q setmeta -h "Cache-Control:public, max-age=60" -r $gs
gsutil -m -q acl -r ch -u AllUsers:R $gs

echo test http://www.bsteele.com/$flavor/bsteeleMusicApp
ls -l lib/assets/utcDate.txt
cat lib/assets/utcDate.txt
