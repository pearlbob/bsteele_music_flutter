#!/bin/tcsh
set echo; set verbose

echo $0\:

sudo echo sudo required for local app server install: 

set debug=0
#   default is beta:
set isBeta=1
set app=bsteeleMusicApp
set flavor=beta
set git=~/github/bsteele_music_flutter
set bsteeleMusicLib=~/github/bsteeleMusicLib
set allSongs=~/github/allSongs.songlyrics

while ( $#argv > 0 )
	switch ( $1 )
	case '-a':
	case '-alpha':
		set isBeta=1
		set flavor=alpha
		shift
		continue;
	case '-beta':
		set isBeta=1
		shift
		continue;
	case '-d':		#	debug
	case '-debug':
		set debug=1
		shift
		continue;
	default:
		echo unknown argument: $1
		exit -1;
		breaksw;
	endsw

	break;
end


if ( $debug != 0 ) then
	set echo; set verbose
endif

#done by arch: gcloud --quiet components update

#	test
cd $git
flutter test test
if ( $status != 0 ) echo test status: $status

#	beta to local static host
set rootDir=/srv/http/public_html/bsteeleMusicApp
set betaDir=$rootDir/$flavor

# 
echo test the library
cd $bsteeleMusicLib/bsteele_music_lib
flutter test >& /dev/null
if ( $status != 0 ) then
	echo library tests failed.
	exit -1
endif
cd $git

##	build the web version of the beta
flutter clean
date --utc +%Y%m%d_%H%M%S > lib/assets/utcDate.txt
#flutter config --enable-web
set base=/bsteeleMusicApp/
if ( $isBeta ) set base=/public_html${base}beta/
if ( $debug ) then
	#flutter build web --profile --web-renderer=auto --dart-define=Dart2jsOptimization=O0
	flutter build web --base-href $base --web-renderer=auto	#	fixme: temp
else
	flutter build web --base-href $base --release --web-renderer=auto
endif
bsteeleMusicApp_canvaskit # offline canvas kit update

# install beta lib util
cd bsteeleMusicLib
bin/bsteeleMusicUtil_install
cd $git

#	clear the last one
mkdir -p $betaDir
rm  -rf $betaDir/*

#	copy to localhost website
cp -r build/web/* $betaDir
cp $allSongs/allSong* $rootDir  # include song data

##	build the web cloud version of the beta
set base=/bsteeleMusicApp/
if ( $isBeta ) set base=${base}beta/
if ( $debug ) then
	#flutter build web --profile --web-renderer=auto --dart-define=Dart2jsOptimization=O0
	flutter build web --base-href $base --web-renderer=auto	#	fixme: temp
else
	flutter build web --base-href $base --release --web-renderer=auto
endif

#	send to flavor's web location
set gs=gs://www.bsteele.com/$app/$flavor
bsteele_auth
gsutil -m -q rsync -d -R \
    -x 'allSongs\.songlyrics$' \
    -x 'allSongs\.songmetadata$' \
    -x 'allSongPerformances\.songperformances$' \
    build/web/ $gs 	#	source needs the /
gsutil -m -q setmeta -h "Cache-Control:public, max-age=60" -r $gs
gsutil -m -q acl -r ch -u AllUsers:R $gs

echo test http://www.bsteele.com/$app/$flavor

#	deploy to local tomcat
cd $git
bin/bsteeleMusicApp_beta_war

# print some facts
bin/bsteeleMusicApp_codeLineCount
cat lib/assets/utcDate.txt
